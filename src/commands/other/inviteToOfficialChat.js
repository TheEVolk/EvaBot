import { Keyboard } from 'vk-io'

export default class {
  name = '–±–µ—Å–µ–¥–∞'
  description = '–ø–æ–ø–∞—Å—Ç—å –≤ –æ—Ñ—Ñ. –∫–æ–Ω—Ñ—É'
  emoji = 'üéà'

  async checkFriends (ctx) {
    await ctx.api.friends.add({
      access_token: ctx.henta.config.private.pageToken,
      user_id: ctx.user.vkId
    })

    const areFriends = await ctx.api.friends.areFriends({
      access_token: ctx.henta.config.private.pageToken,
      user_ids: ctx.user.vkId
    })

    return areFriends[0].friend_status === 3
  }

  sendFriendsError (ctx) {
    return ctx.builder()
      .lines([
        'üéé –î–æ–±–∞–≤—å—Ç–µ @evarobot –≤ –¥—Ä—É–∑—å—è, –ø–æ—Å–ª–µ —á–µ–≥–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.',
        'üé´ –í—ã –±—É–¥–µ—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –±–µ—Å–µ–¥—É —Å –ø–æ–º–æ—â—å—é —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –ü–æ–∑–∂–µ –≤—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å –µ—ë –∏–∑ –¥—Ä—É–∑–µ–π.'
      ])
      .keyboard(Keyboard.builder()
        .textButton({ label: `üëÄ –ü—Ä–æ—Ñ–∏–ª—å`, payload: { command: '–ø—Ä–æ—Ñ–∏–ª—å' } })
      )
      .answer()
  }

  async handler (ctx) {
    if (!await this.checkFriends(ctx)) {
      return this.sendFriendsError(ctx)
    }

    try {
      await ctx.api.messages.addChatUser({
        chat_id: 306,
        user_id: ctx.user.vkId,
        access_token: ctx.henta.config.private.pageToken
      })

      ctx.answer([
        'üéé –Ø –¥–æ–±–∞–≤–∏–ª–∞ —Ç–µ–±—è –≤ —Å–≤–æ—é –±–µ—Å–µ–¥—É.',
        'üç≠ –ü—Ä–æ—á–∏—Ç–∞–π –ø—Ä–∞–≤–∏–ª–∞, —á—Ç–æ–±—ã —Ç–µ–±—è –Ω–µ –≤—ã–≥–Ω–∞–ª–∏:',
        'vk.com/@bot_eva-chat-rules'
      ])
    } catch (e) {
      ctx.answer('–í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –±–µ—Å–µ–¥–µ.')
    }
  }
}
